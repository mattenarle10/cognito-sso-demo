- Create an AWS Cognito with the following functionality
    - Signin via Email and Password - returns token set that your FE will be able to use
    - Register via Email
        - this should have a pre-token trigger that creates the user to a DynamoDB table as well
        - OTP for email
- Create two frontends:
    - SSO FE with the following pages:
        - Login
        - Register - with email, phone number, password, name, and gender
            - ensure that you get OTP for email
    - Client Application FE
        - Homepage
        - Logged in homepage showing the orders of the user - shown only for logged in users
- Create two backends:
    - SSO BE
    - Client Application BE
        - needs token from Cognito to determine the user is authenticated and who the user is (via user id)
        - endpoints:
            - Show All Orders (for that user)
            1. from the client app homepage, the user clicks Login and is redirected to the SSO FE Login page
2. to distinguish between different Client Application FE that may call the SSO FE, add an application_id and a channel_id to the URL of the SSO FE once it is called
    - for example:
        - Client Application FE: `smacandshop.com`
        - SSO FE: `sso.smadvantage.com`
        - so when calling SSO FE, do `sso.smadvantage.com?application_name=smacandshop&client_id=mobile`
    - in your SSO BE, the application and its channels are stored in a DynamoDB. You will throw an error once SSO FE Login or Register page is called with an app or channel that does not exist.
3. the user uses the form to login with email and password (which uses Cognito APIs)
4. cognito verifies the credentials and returns a token
5. the SSO FE calls the SSO BE to validate if the user has authorized the application for access. If not, throw an error. Ofcourse, at this point, the SSO FE already has the tokenset, which it includes inside the request to the SSO BE. The SSO BE uses the token to identify the user by their user_id or sub
6. If app is authorized, SSO FE calls the SSO BE initialize sessions to send the token set sent by Cognito. The SSO BE returns a session_id
7. The SSO FE now redirects to the client application using the URL from Step 2, but this time with the parameter session_id
    1. Client Application FE: `smac.ph/success?session_id=12234323521`
8. The Client Application FE uses this session_id to call the SSO BE to get the tokenset for this user

## Register

![Screenshot 2025-07-13 at 11.00.37â€¯PM.png](attachment:588eb604-72b3-4c8b-8de2-f742cf3e8b75:Screenshot_2025-07-13_at_11.00.37_PM.png)

1. User registers with the following attributes: (copy the SSO FE in SMAC)
    1. email
    2. phone
    3. name
    4. gender
    5. accepts_marketing
2. The request is sent directly to Cognito
3. Cognito has a post sign up trigger that gets this information and saves it to DynamoDB, along with the sub generated by adding a Cognito user. The user has automatically authorized this particular application
4. At this point, the user is email_unconfirmed. So we send an email OTP to the user
5. The user types in the OTP
6. If correct, the system returns the token set
7. the SSO FE calls the SSO BE to validate if the user has authorized the application for access. If not, throw an error. Ofcourse, at this point, the SSO FE already has the tokenset, which it includes inside the request to the SSO BE. The SSO BE uses the token to identify the user by their user_id or sub
8. If app is authorized, SSO FE calls the SSO BE initialize sessions to send the token set sent by Cognito. The SSO BE returns a session_id
9. The SSO FE now redirects to the client application using the URL from Step 2, but this time with the parameter session_id
10. The Client Application FE uses this session_id to call the SSO BE to get the tokenset for this user

## Client Application - Show All Orders (for that user)

1. given that the user is logged in already and the Client App FE has the token set
2. call the client app BE to get the orders for that user
    1. Url: /orders
    2. Header:
        1. Authorization: << ID Token >>
3. Inside the logic
    1. download the public key from Cognitoâ€™s URL
    2. use that public key to verify the JWT token
    3. get the user_id from the token
    4. use that user_id to get the orders of the user
    5. return that

## Refresh Token - n/a

## 

- 

## DB Schema - same table, but different entities

<aside>
ðŸ’¡

this is a single DynamoDB Table

</aside>

### Applications

```json
{
	"PK": "application-smdac",
	"SK":  "application",
	"application_id": "smdac",
	"channels": [
		{
			"channel_id": "1233",
			"return_url": "https://jamby.com"
		}
	]
	"created_at": ""
}
```

### Application-User

```json
{
	"PK": "application-smdac",
	"SK": "user-1234",
	"application_id": "smdac",
	"user_id": "user-1243",
	"created_at": ""
}
```

### User

```json
{
	"PK": "user-1234",
	"SK": "user",
	...
	"sub": "sfqqwcqqwcqe12e21"
}
```

### Session

```json
{
	"PK": "user-1234",
	"SK": "session-12345",
	"tokenset": {
		"access_token": "",
		"identity_token": "",
		"refresh_token": ""
	}
}
```

### Orders

<aside>
ðŸ’¡

This is a *separate* DynamoDB table

</aside>

```json
{
	"PK": "user-1234",
	"SK": "order-1222",
	"user_id": "user-1234",
	"order_id": "order-1222"
}
```

## Inventory of what you have to make

- 1 x DynamoDB Table with the following data entities
    - application
    - application-user
    - user
    - session
- 1 x DynamoDB for:
    - orders
- SSO BE API
    - API - validate application-user authorization
    - API - initialize session
    - API - get session
    - Post Registration Hook - create user in DynamoDB
- Cognito usage
    - Login
    - Register
    - Post Registration Hook
- SSO FE Pages
    - Login
    - Registration
- Client Application BE API
    - show orders
- Client Application FE pages
    - signed out homepage
    - signed in - show orders page
    - signed in - create one order